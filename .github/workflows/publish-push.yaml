name: publish-push

on:
  push:
    branches:
      - main

env:
  HUSKY: 0

jobs:
  publish:
    strategy:
      matrix:
        args:
          [
            {
              dockerfile: "DragaliaAPI.Photon.StateManager/Dockerfile",
              image: "photon-state-manager",
            },
            { dockerfile: "DragaliaAPI/Dockerfile", image: "dragalia-api" }
          ]
    uses: ./.github/workflows/publish.yaml
    with:
      ref: main
      dockerfile: ${{ matrix.args.dockerfile }}
      image-name: ${{ matrix.args.image }}
      image-tag: latest
    secrets: inherit

  deploy:
    strategy:      
      # Nomad will re-template Dawnshard when PhotonStateManager's address changes. 
      # Deploy PSM first to avoid a double redeploy.
      # TODO: Consider using Consul DNS to work around this problem
      max-parallel: 1 
      matrix:
        github-environment: ["PhotonStateManager", "Dawnshard"]
    needs: publish
    uses: ./.github/workflows/deploy.yaml
    with:
      github-environment: ${{ matrix.github-environment }}
    secrets: inherit
